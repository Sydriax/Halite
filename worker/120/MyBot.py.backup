from hlt import *
from networking import *


from keras.models import Sequential, model_from_json
from keras.layers import Dense, Activation
from keras.optimizers import SGD, Adam, RMSprop

import numpy as np


model = model_from_json(open('my_model_architecture.json').read())
model.load_weights('my_model_weights.h5')
#model.compile(loss='categorical_crossentropy', optimizer='adam')

myID, gameMap = getInit()
maxProduction = 0
for y in range(gameMap.height):
    for x in range(gameMap.width):
        prod = gameMap.getSite(Location(x, y)).production
        if prod > maxProduction:
            maxProduction = prod

with open('net-info.txt', 'w') as f:
    sendInit("rustyBot")
    while True:
        moves = []
        gameMap = getFrame()
        for y in range(gameMap.height):
            for x in range(gameMap.width):
                loc = Location(x, y)
                if gameMap.getSite(loc).owner == myID:
                    box = [
                        gameMap.getSite(gameMap.getLocation(loc, NORTH, NORTH, WEST, WEST)),
                        gameMap.getSite(gameMap.getLocation(loc, NORTH, NORTH, WEST)),
                        gameMap.getSite(gameMap.getLocation(loc, NORTH, NORTH)),
                        gameMap.getSite(gameMap.getLocation(loc, NORTH, NORTH, EAST)),
                        gameMap.getSite(gameMap.getLocation(loc, NORTH, NORTH, EAST, EAST)),
                        gameMap.getSite(gameMap.getLocation(loc, NORTH, WEST, WEST)),
                        gameMap.getSite(gameMap.getLocation(loc, NORTH, WEST)),
                        gameMap.getSite(gameMap.getLocation(loc, NORTH)),
                        gameMap.getSite(gameMap.getLocation(loc, NORTH, EAST)),
                        gameMap.getSite(gameMap.getLocation(loc, NORTH, EAST, EAST)),
                        gameMap.getSite(gameMap.getLocation(loc, WEST, WEST)),
                        gameMap.getSite(gameMap.getLocation(loc, WEST)),
                        gameMap.getSite(gameMap.getLocation(loc, EAST)),
                        gameMap.getSite(gameMap.getLocation(loc, EAST, EAST)),
                        gameMap.getSite(gameMap.getLocation(loc, SOUTH, WEST, WEST)),
                        gameMap.getSite(gameMap.getLocation(loc, SOUTH, WEST)),
                        gameMap.getSite(gameMap.getLocation(loc, SOUTH)),
                        gameMap.getSite(gameMap.getLocation(loc, SOUTH, EAST)),
                        gameMap.getSite(gameMap.getLocation(loc, SOUTH, EAST, EAST)),
                        gameMap.getSite(gameMap.getLocation(loc, SOUTH, SOUTH, WEST, WEST)),
                        gameMap.getSite(gameMap.getLocation(loc, SOUTH, SOUTH, WEST)),
                        gameMap.getSite(gameMap.getLocation(loc, SOUTH, SOUTH)),
                        gameMap.getSite(gameMap.getLocation(loc, SOUTH, SOUTH, EAST)),
                        gameMap.getSite(gameMap.getLocation(loc, SOUTH, SOUTH, EAST, EAST)),                        
                    ]
                    nnInput = []
                    for site in box:
                        nnInput += [1 if site.owner == myID else -1, float(site.strength / 255), float(site.production / maxProduction)]
                    nnInput = np.asarray(nnInput).reshape((1, 72))

                    f.write("{},{}\n".format(x, y))
                    f.write("Net results\n")

                    
                    output = model.predict(nnInput)[0]
                    biggest = -222
                    direction = STILL
                    check = range(len(output))

                    f.write("Strength {}\n".format(gameMap.getSite(loc).strength));
                    if gameMap.getSite(loc).strength < 12:
                        check = [0]
                        
                    for d in check:
                        f.write("output {} {} biggest {}\n".format(d, output[d], biggest))
                        if output[d] > biggest:
                            biggest = output[d]
                            direction = d
                            
                    f.write("Picked direction {}\n".format(direction))
                    f.write("other cell strength: {}\n".format(gameMap.getSite(gameMap.getLocation(loc, direction)).strength))
                    moves.append(Move(loc, direction))
        sendFrame(moves)

